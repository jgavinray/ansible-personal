---
- name: "Check if node is already joined to cluster (1/3)"
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: node_joined

- name: "Generate join token for workers (2/3)"
  shell: /usr/local/bin/kubeadm token create --print-join-command
  register: kubeadm_join_cmd
  delegate_to: "{{groups['k8s_leaders'][0]}}"
  when: not node_joined.stat.exists

- set_fact:
    kubeadm_join: "{{ kubeadm_join_cmd.stdout }}"
  when: not node_joined.stat.exists

- name: "Run kubeadm join for workers (3/3)"
  shell: "{{ kubeadm_join }}"
  when: not node_joined.stat.exists

- name: "Display skip message if already joined (4/4)"
  debug:
    msg: "Worker node already joined to cluster, skipping join operation"
  when: node_joined.stat.exists
