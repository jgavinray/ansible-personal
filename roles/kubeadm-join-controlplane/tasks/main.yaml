---
- name: "Check if master node is already joined to cluster (1/6)"
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: master_joined

- name: "Create kubernetes folders (2/6)"
  file:
    path: /etc/kubernetes/pki/etcd
    state: directory
    mode: 0640
    owner: root
    group: root
  when: not master_joined.stat.exists

- name: "Push Kubernetes Master PKI files to master replicas  (3/6)"
  copy:
    src: /tmp/kubeadm-ha/
    dest: /etc/kubernetes/
    owner: root
    group: root
    mode: preserve
  when: not master_joined.stat.exists
#  set .crt to 640 set all else to 600

- name: "Generate master join token  (4/6)"
  shell: '/usr/local/bin/kubeadm token create --print-join-command'
  register: kubeadm_join_cmd
  delegate_to: "{{groups['k8s_leaders'][0]}}"
  when: not master_joined.stat.exists

- set_fact:
    kubeadm_join: "{{ kubeadm_join_cmd.stdout }}"
  when: not master_joined.stat.exists

- name: "Join Master replicas to cluster  (5/6)"
  shell: "{{ kubeadm_join }} --control-plane"
  when: not master_joined.stat.exists

- name: "Display skip message if already joined (6/6)"
  debug:
    msg: "Master node already joined to cluster, skipping join operation"
  when: master_joined.stat.exists
