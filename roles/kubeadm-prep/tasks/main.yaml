---
- name: "Create Kubernetes binary directory"
  become: true
  ansible.builtin.file:
    path: "{{ kubernetes_download_directory }}"
    state: directory
    recurse: true

- name: "Create CNI plugin directory"
  become: true
  ansible.builtin.file:
    path: /opt/cni/bin
    state: directory
    recurse: true

- name: "Download CNI Plugin"
  become: true
  ansible.builtin.get_url:
    url: "https://github.com/containernetworking/plugins/releases/download/{{ cni_plugin_version }}/cni-plugins-linux-{{ kubernetes_arch }}-{{ cni_plugin_version }}.tgz"
    dest: "/opt/cni/cni-{{ cni_plugin_version }}.tgz"

- name: "Extract cni.tgz into /opt/cni/bin"
  become: true
  ansible.builtin.unarchive:
    src:  "/opt/cni/cni-{{ cni_plugin_version }}.tgz"
    dest: "/opt/cni/bin"
    remote_src: true

- name: "Download CRICTL"
  become: true
  ansible.builtin.get_url:
    url: "https://github.com/kubernetes-sigs/cri-tools/releases/download/{{ kubernetes_version }}/crictl-{{ kubernetes_version }}-linux-{{ kubernetes_arch }}.tar.gz"
    dest: "{{ kubernetes_download_directory }}/crictl-{{ kubernetes_version }}.tar.gz"

- name: "Extract CRICTL"
  become: true
  ansible.builtin.unarchive:
    src:  "{{ kubernetes_download_directory }}/crictl-{{ kubernetes_version }}.tar.gz"
    dest: "{{ kubernetes_download_directory }}"
    remote_src: true

- name: "Download kubeadm"
  become: true
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ kubernetes_version }}/bin/linux/{{ kubernetes_arch }}/kubeadm"
    dest: "{{ kubernetes_download_directory }}"
    mode: '0755'

- name: "Download kubelet"
  become: true
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ kubernetes_version }}/bin/linux/{{ kubernetes_arch }}/kubeadm"
    dest: "{{ kubernetes_download_directory }}"
    mode: '0755'

- name: "Download kubelet.service"
  become: true
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/kubernetes/release/v0.4.0/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service"
    dest: "{{ kubernetes_download_directory }}"

- name: "Download kubeadm.service"
  become: true
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/kubernetes/release/v0.4.0/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf"
    dest: "{{ kubernetes_download_directory }}"

- name: "Kubelet service"
  become: true
  replace:
    path: "{{ kubernetes_download_directory }}/kubelet.service"
    regexp: '/usr/bin'
    replace: "{{ kubernetes_download_directory }}"

- name: "Create kubelet systemd directory"
  become: true
  ansible.builtin.file:
    path: "/etc/systemd/system/kubelet.service.d"
    state: directory
    recurse: true

- name: "Move kubelet service"
  become: true
  ansible.builtin.copy:
    src: "{{ kubernetes_download_directory }}/kubelet.service"
    dest: "/etc/systemd/system/kubelet.service"
    remote_src: true

- name: "Kubeadmn service"
  become: true
  replace:
    path: "{{ kubernetes_download_directory }}/10-kubeadm.conf"
    regexp: '/usr/bin'
    replace: "{{ kubernetes_download_directory }}"

- name: "Move kubeadm config file"
  become: true
  ansible.builtin.copy:
    src: "{{ kubernetes_download_directory }}/10-kubeadm.conf"
    dest: "/etc/systemd/system/kubelet.service.d/10-kubeadm.conf"
    remote_src: true

- name: "Enable service kubelet"
  become: true
  ansible.builtin.systemd:
    name: kubelet
    daemon_reload: true
    state: started
    enabled: true
