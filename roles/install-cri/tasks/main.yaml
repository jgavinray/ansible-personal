---
- name: "Check if Docker is already installed (1/4)"
  command: docker --version
  register: docker_check
  failed_when: false
  changed_when: false

- name: "Install Docker from repos if not present (2/4)"
  apt:
    name: docker.io
    state: present
  when: docker_check.rc != 0

- name: "Install Docker Daemon Config (3/7)"
  template:
    src: daemon.json
    dest: /etc/docker/daemon.json

- name: "Check if containerd config exists (4/7)"
  stat:
    path: /etc/containerd/config.toml
  register: containerd_config

- name: "Create containerd config directory (5/7)"
  file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: "Generate default containerd config if not present (6/7)"
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: "Enable CRI plugin in containerd if disabled (7/7)"
  replace:
    path: /etc/containerd/config.toml
    regexp: '^(disabled_plugins = \["cri"\])$'
    replace: |
      # Commented by Ansible to enable Kubernetes CRI support
      # Original NVIDIA configuration disabled CRI plugin for Docker integration
      # Enabling this allows kubeadm to use containerd as container runtime
      #\1
  register: containerd_cri_fixed

- name: "Enable SystemdCgroup in containerd for Kubernetes (8/7)"
  replace:
    path: /etc/containerd/config.toml
    regexp: '(\s+)SystemdCgroup = false'
    replace: '\1SystemdCgroup = true'
  register: containerd_systemd_cgroup_fixed

- name: "Restart containerd if config was changed (9/7)"
  systemd:
    name: containerd
    state: restarted
  when: containerd_cri_fixed.changed or containerd_systemd_cgroup_fixed.changed

- name: "Start and enable Docker (10/7)"
  systemd:
    state: started
    daemon_reload: yes
    name: docker
    enabled: yes